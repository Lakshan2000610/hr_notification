-- =============================================
-- HR NOTIFICATION SYSTEM - FULL MYSQL SCHEMA
-- Run this once to create all tables
-- =============================================

CREATE DATABASE IF NOT EXISTS hr_notification CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE hr_notification;

-- 1. Employees
CREATE TABLE IF NOT EXISTS employees (
    id VARCHAR(36) PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 2. Employee Devices (one-to-one with employee)
CREATE TABLE IF NOT EXISTS employee_devices (
    employee_id VARCHAR(36) PRIMARY KEY,
    status TINYINT(1) DEFAULT 0,
    active_status TINYINT(1) DEFAULT 0,
    hostname VARCHAR(255) DEFAULT 'unknown-host',
    email VARCHAR(255) NOT NULL,
    last_seen DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    app_running TINYINT(1) DEFAULT 0,
    ip VARCHAR(45),
    device_type VARCHAR(50),
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    INDEX idx_active (active_status),
    INDEX idx_last_seen (last_seen)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 3. Scheduled Content
CREATE TABLE IF NOT EXISTS scheduled_content (
    id VARCHAR(36) PRIMARY KEY,
    type VARCHAR(20) NOT NULL,
    title VARCHAR(255) NOT NULL,
    text TEXT,
    image_url TEXT,
    url TEXT,
    scheduled_time DATETIME NOT NULL,
    employees JSON NOT NULL, -- Stores array like ["emp1", "emp2"]
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_time (scheduled_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. Notifications (sent 5 mins before content)
CREATE TABLE IF NOT EXISTS notifications (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    content_id VARCHAR(36) NOT NULL,
    employees JSON NOT NULL,
    time DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES scheduled_content(id) ON DELETE CASCADE,
    INDEX idx_content (content_id),
    INDEX idx_time (time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 5. Reactions (one reaction per employee per content)
CREATE TABLE IF NOT EXISTS reactions (
    id VARCHAR(36) PRIMARY KEY,
    content_id VARCHAR(36) NOT NULL,
    employee_id VARCHAR(36) NOT NULL,
    reaction ENUM('like','unlike','heart','cry') NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_reaction (content_id, employee_id),
    FOREIGN KEY (content_id) REFERENCES scheduled_content(id) ON DELETE CASCADE,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    INDEX idx_content (content_id),
    INDEX idx_employee (employee_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 6. Feedback
CREATE TABLE IF NOT EXISTS feedback (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    content_id VARCHAR(36) NOT NULL,
    employee_id VARCHAR(36) NOT NULL,
    feedback TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES scheduled_content(id) ON DELETE CASCADE,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    INDEX idx_content (content_id),
    INDEX idx_employee (employee_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 7. Views (track how long content was viewed)
CREATE TABLE IF NOT EXISTS views (
    id VARCHAR(36) PRIMARY KEY,
    content_id VARCHAR(36) NOT NULL,
    employee_id VARCHAR(36) NOT NULL,
    viewed_duration INT DEFAULT 0,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_view (content_id, employee_id),
    FOREIGN KEY (content_id) REFERENCES scheduled_content(id) ON DELETE CASCADE,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    INDEX idx_content (content_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 8. Message Preferences (delay choice per employee per content)
CREATE TABLE IF NOT EXISTS message_preferences (
    employee_id VARCHAR(36) NOT NULL,
    content_id VARCHAR(36) NOT NULL,
    delay_choice VARCHAR(50) NOT NULL,
    display_time DATETIME NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (employee_id, content_id),
    FOREIGN KEY (content_id) REFERENCES scheduled_content(id) ON DELETE CASCADE,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 9. Device Update Status (for app.exe updates)
CREATE TABLE IF NOT EXISTS device_update_status (
    id VARCHAR(36) PRIMARY KEY,
    employee_id VARCHAR(36) NOT NULL,
    device_id VARCHAR(36) NOT NULL,
    version VARCHAR(50),
    status ENUM('success','pending','failed') DEFAULT 'pending',
    error_message TEXT,
    last_attempted_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_device (employee_id, device_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 10. Groups
CREATE TABLE IF NOT EXISTS `groups` (
                id INT AUTO_INCREMENT PRIMARY KEY,
                name VARCHAR(255) NOT NULL,
                description TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 11. Group Emails
CREATE TABLE IF NOT EXISTS group_members (
                group_id INT NOT NULL,
                employee_id VARCHAR(255) NOT NULL,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (group_id, employee_id),
                FOREIGN KEY (group_id) REFERENCES `groups`(id) ON DELETE CASCADE,
                FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =============================================
-- DONE! All tables created.
-- Now your Flask app with MySQL will work perfectly.
-- =============================================
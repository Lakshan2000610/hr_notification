{% extends "base.html" %}
{% block title %}Monitor Devices{% endblock %}
{% block content %}

<!-- Bootstrap Icons CDN (for perfect check/cross icons) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
    :root {
        --primary: #7F5FCF;
        --light: #B6A3D8;
        --bg: #F5F0FF;
        --success: #27ae60;
        --danger: #e74c3c;
        --card-shadow: 0 20px 60px rgba(127, 95, 207, 0.18);
    }

    body {
        background: linear-gradient(135deg, #F5F0FF 0%, #E8E0FF 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
    }

    .container {
        max-width: 1400px;
        margin: 50px auto;
        padding: 40px;
        background: white;
        border-radius: 28px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(182, 163, 216, 0.2);
        position: relative;
        overflow: hidden;
    }
    .container::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 8px;
        background: linear-gradient(90deg, #7F5FCF, #B6A3D8, #7F5FCF);
        border-radius: 28px 28px 0 0;
    }

    h1 {
        color: #5D3FA3;
        text-align: center;
        font-weight: 800;
        font-size: 2.8em;
        margin-bottom: 50px;
        background: linear-gradient(90deg, #7F5FCF, #9D7BE1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    h2 {
        color: #7F5FCF;
        font-weight: 700;
        font-size: 1.8em;
        margin: 50px 0 25px;
        position: relative;
        padding-bottom: 12px;
    }
    h2::after {
        content: '';
        position: absolute;
        left: 0; bottom: 0;
        width: 100px;
        height: 5px;
        background: linear-gradient(90deg, #7F5FCF, #B6A3D8);
        border-radius: 3px;
        box-shadow: 0 4px 10px rgba(127, 95, 207, 0.3);
    }

    .alert-danger {
        background: #fdf0f3; color: #a0333b; border: 1px solid #f5c6cb;
        border-radius: 16px; padding: 16px; font-weight: 500;
    }

    .btn-success, .btn-danger, .btn-secondary {
        border-radius: 12px; font-weight: 600; padding: 10px 20px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    .btn-success { background: linear-gradient(135deg, #27ae60, #2ecc71); border: none; }
    .btn-success:hover { background: #219653; transform: translateY(-3px); }
    .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); border: none; }
    .btn-danger:hover { background: #c0392b; transform: translateY(-2px); }
    .btn-secondary { background: #B6A3D8; border: none; }
    .btn-secondary:hover { background: #9f8cc4; }

    .table {
        border-radius: 18px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .table thead {
        background: linear-gradient(135deg, #7F5FCF, #9D7BE1);
        color: white; font-weight: 600;
    }
    .table th, .table td { padding: 16px; vertical-align: middle; font-size: 0.95em; }
    .table-striped tbody tr:nth-of-type(odd) { background-color: #f8f4ff; }
    .table tbody tr:hover { background-color: #f0e6ff !important; transform: scale(1.01); transition: all 0.2s; }

    .form-check-input {
        width: 1.3em; height: 1.3em; border: 2px solid #B6A3D8; cursor: pointer;
    }
    .form-check-input:checked {
        background-color: var(--primary); border-color: var(--primary);
    }

    .pagination-controls {
        display: flex; justify-content: center; align-items: center; gap: 15px; margin: 30px 0;
    }
    .pagination-controls button {
        border-radius: 12px; padding: 10px 20px; font-weight: 600;
    }
    .pagination-controls span {
        background: #7F5FCF; color: white; padding: 10px 20px;
        border-radius: 12px; font-weight: 600;
    }

    /* Perfect check/cross icons */
    .verify-icon {
        font-size: 1.6em;
        font-weight: bold;
    }
    .verify-ok { color: #27ae60; }
    .verify-fail { color: #e74c3c; }

    @media (max-width: 992px) {
        .container { margin: 20px; padding: 25px; }
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.6em; }
        .table { font-size: 0.85em; }
        .verify-icon { font-size: 1.4em; }
    }
</style>

<div class="container">
    <h1>Monitor Devices</h1>

    {% if error %}
    <div class="alert alert-danger text-center">{{ error }}</div>
    {% endif %}

    <!-- Inactive Devices -->
    <h2>Inactive Devices</h2>
    <div class="mb-4 text-end">
        <button id="allActiveInactive" class="btn btn-success">Activate All Selected</button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>#</th>
                    <th><input type="checkbox" id="selectAllInactive" onchange="toggleSelectAll('inactive')"></th>
                    <th>Email</th>
                    <th>Hostname</th>
                    <th>Status</th>
                    <th>Last Seen</th>
                    <th>App Running</th>
                    <th>Device Type</th>
                    <th>Verification</th>
                    <th<span class="d-none d-md-table-cell">Action</span></th>
                </tr>
            </thead>
            <tbody id="inactiveDeviceTable">
                {% for device in inactive_devices %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><input type="checkbox" data-employee-id="{{ device.employee_id }}"></td>
                    <td><strong>{{ device.email | default('N/A') }}</strong></td>
                    <td>{{ device.hostname | default('N/A') }}</td>
                    <td><span class="badge bg-warning text-dark">{{ 'Online' if device.status else 'Offline' }}</span></td>
                    <td>{{ device.last_seen | default('Never') }}</td>
                    <td>{{ 'Yes' if device.app_running else 'No' }}</td>
                    <td>{{ device.device_type | default('Unknown') }}</td>
                    <td>
                        {% if device.is_hostname_valid is defined and device.is_email_valid is defined and device.is_ip_valid is defined %}
                            {% if device.is_hostname_valid and device.is_email_valid and device.is_ip_valid %}
                                <i class="bi bi-check-circle-fill verify-icon verify-ok" 
                                   data-bs-toggle="tooltip" title="All verified: Hostname, Email & IP matched"></i>
                            {% else %}
                                <i class="bi bi-x-circle-fill verify-icon verify-fail"
                                   data-bs-toggle="tooltip" 
                                   title="Hostname: {{ 'OK' if device.is_hostname_valid else 'Failed' }}
Email: {{ 'OK' if device.is_email_valid else 'Failed' }}
IP: {{ 'OK' if device.is_ip_valid else 'Failed' }}"></i>
                            {% endif %}
                        {% else %}
                            <i class="bi bi-question-circle text-muted" data-bs-toggle="tooltip" title="Incomplete data"></i>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="updateDeviceStatus('{{ device.employee_id }}', true)">
                            Activate
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="10" class="text-center py-5 text-muted"><h5>No inactive devices found</h5></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-controls">
        <button id="prevInactive" class="btn btn-secondary" onclick="changePage('inactive', -1)" disabled>Previous</button>
        <span id="pageInfoInactive">Page 1</span>
        <button id="nextInactive" class="btn btn-secondary" onclick="changePage('inactive', 1)">Next</button>
    </div>

    <!-- Active Devices -->
    <h2>Active Devices</h2>
    <div class="mb-4 text-end">
        <button id="allDeactiveActive" class="btn btn-danger">Deactivate All Selected</button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>#</th>
                    <th><input type="checkbox" id="selectAllActive" onchange="toggleSelectAll('active')"></th>
                    <th>Email</th>
                    <th>Hostname</th>
                    <th>Status</th>
                    <th>Last Seen</th>
                    <th>App Running</th>
                    <th>Device Type</th>
                    <th>Verification</th>
                    <th<span class="d-none d-md-table-cell">Action</span></th>
                </tr>
            </thead>
            <tbody id="activeDeviceTable">
                {% for device in active_devices %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><input type="checkbox" data-employee-id="{{ device.employee_id }}"></td>
                    <td><strong>{{ device.email | default('N/A') }}</strong></td>
                    <td>{{ device.hostname | default('N/A') }}</td>
                    <td><span class="badge bg-success">{{ 'Online' if device.status else 'Offline' }}</span></td>
                    <td>{{ device.last_seen | default('Just now') }}</td>
                    <td>{{ 'Yes' if device.app_running else 'No' }}</td>
                    <td>{{ device.device_type | default('Unknown') }}</td>
                    <td>
                        {% if device.is_hostname_valid is defined and device.is_email_valid is defined and device.is_ip_valid is defined %}
                            {% if device.is_hostname_valid and device.is_ip_valid %}
                                <i class="bi bi-check-circle-fill verify-icon verify-ok"
                                   data-bs-toggle="tooltip" title="Verified: Hostname & IP matched"></i>
                            {% else %}
                                <i class="bi bi-x-circle-fill verify-icon verify-fail"
                                   data-bs-toggle="tooltip" 
                                   title="Hostname: {{ 'OK' if device.is_hostname_valid else 'Failed' }}
IP: {{ 'OK' if device.is_ip_valid else 'Failed' }}"></i>
                            {% endif %}
                        {% else %}
                            <i class="bi bi-question-circle text-muted" data-bs-toggle="tooltip" title="Incomplete data"></i>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="updateDeviceStatus('{{ device.employee_id }}', false)">
                            Deactivate
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="10" class="text-center py-5 text-muted"><h5>No active devices found</h5></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-controls">
        <button id="prevActive" class="btn btn-secondary" onclick="changePage('active', -1)" disabled>Previous</button>
        <span id="pageInfoActive">Page 1</span>
        <button id="nextActive" class="btn btn-secondary" onclick="changePage('active', 1)">Next</button>
    </div>
</div>

<script>
    let inactivePage = 1;
    let activePage = 1;
    const pageSize = 10;
    let inactiveRows = [];
    let activeRows = [];

    try {
        inactiveRows = JSON.parse('{{ inactive_devices | tojson | safe }}');
        activeRows = JSON.parse('{{ active_devices | tojson | safe }}');
    } catch (e) {
        console.error('Error parsing device data:', e);
        inactiveRows = []; activeRows = [];
    }

    function updateTable(tableType) {
        const table = document.getElementById(`${tableType}DeviceTable`);
        const pageInfo = document.getElementById(`pageInfo${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
        const prevButton = document.getElementById(`prev${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
        const nextButton = document.getElementById(`next${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
        const rows = tableType === 'inactive' ? inactiveRows : activeRows;
        const currentPage = tableType === 'inactive' ? inactivePage : activePage;

        const maxRows = Array.isArray(rows) ? rows.length : 0;
        const totalPages = Math.ceil(maxRows / pageSize) || 1;
        const startIdx = (currentPage - 1) * pageSize;
        const endIdx = Math.min(startIdx + pageSize, maxRows);

        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages;

        const tableRows = table.querySelectorAll('tr');
        tableRows.forEach((row, index) => {
            if (maxRows === 0 && index === 0) {
                row.style.display = '';
            } else {
                row.style.display = (index >= startIdx && index < endIdx) ? '' : 'none';
            }
        });

        // Re-init tooltips
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            if (el._tooltip) el._tooltip.dispose();
            new bootstrap.Tooltip(el);
        });
    }

    function changePage(tableType, delta) {
        const currentPage = tableType === 'inactive' ? inactivePage : activePage;
        let newPage = currentPage + delta;
        const totalRows = tableType === 'inactive' ? inactiveRows.length : activeRows.length;
        const totalPages = Math.ceil(totalRows / pageSize) || 1;

        if (newPage < 1 || newPage > totalPages) return;
        if (tableType === 'inactive') inactivePage = newPage;
        else activePage = newPage;
        updateTable(tableType);
    }

    function toggleSelectAll(tableType) {
        const selectAll = document.getElementById(`selectAll${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
        document.querySelectorAll(`#${tableType}DeviceTable input[type="checkbox"]:not(#selectAll${tableType.charAt(0).toUpperCase() + tableType.slice(1)})`).forEach(cb => {
            cb.checked = selectAll.checked;
        });
    }

    async function updateDeviceStatus(employeeId, newStatus) {
    try {
        const res = await fetch('/update_device_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                employee_id: employeeId, 
                status: newStatus   // ← Now sending 'status', not 'active_status'
            })
        });
        const data = await res.json();
        if (res.ok) {
            alert(`Device ${newStatus ? 'activated' : 'deactivated'} successfully`);
            location.reload();
        } else {
            alert(data.message || 'Failed to update');
        }
    } catch (e) {
        alert('Network error');
    }
}


  async function updateBulkStatus(tableType, newStatus) {
    const checked = document.querySelectorAll(`#${tableType}DeviceTable input[type="checkbox"]:checked`);
    if (checked.length === 0) return alert('No devices selected');

    const updates = Array.from(checked).map(cb => ({
        employee_id: cb.dataset.employeeId,
        status: newStatus   // ← Send 'status', not 'active_status'
    }));

    try {
        const res = await fetch('/update_bulk_device_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        const data = await res.json();
        if (res.ok) {
            alert(`Updated ${updates.length} device(s)`);
            location.reload();
        } else {
            alert(data.message || 'Failed');
        }
    } catch (e) {
        alert('Network error');
    }
}

// Update button listeners
document.getElementById('allActiveInactive').addEventListener('click', () => updateBulkStatus('inactive', true));
document.getElementById('allDeactiveActive').addEventListener('click', () => updateBulkStatus('active', false));

    updateTable('inactive');
    updateTable('active');
</script>
{% endblock %}
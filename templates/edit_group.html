{% extends "base.html" %}

{% block title %}Edit Group - {{ group.name }}{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('group_management') }}">Group Management</a></li>
            <li class="breadcrumb-item active" aria-current="page">Edit Group</li>
        </ol>
    </nav>
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2>{{ group.name }}</h2>
            <p class="text-muted">{{ group.description or 'No description' }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('group_management') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Groups
            </a>
        </div>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<!-- Group Members Table (Now at the Top) -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0">Group Members ({{ emails|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Email Address</th>
                        <th>Added On</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for email in emails %}
                    <tr>
                        <td><strong>{{ email.email }}</strong></td>
                        <td>{{ email.added_at.strftime('%Y-%m-%d %H:%M') if email.added_at else 'â€”' }}</td>
                        <td class="text-center">
                            <form action="{{ url_for('remove_email_from_group') }}" method="POST" class="d-inline">
                                <input type="hidden" name="group_id" value="{{ group.id }}">
                                <input type="hidden" name="email" value="{{ email.email }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Remove this email from the group?')">
                                    <i class="bi bi-x-circle"></i> Remove
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center py-4 text-muted">No members in this group yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Emails to Group section (Now at the Bottom) -->
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Add Active Emails to Group</h5>
        <div style="min-width: 250px;">
            <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="availableEmailSearch" class="form-control"
                    placeholder="Search available emails...">
            </div>
        </div>
    </div>
    <div class="card-body">
        <form action="{{ url_for('add_multiple_emails_to_group') }}" method="POST" id="addMultiForm">
            <input type="hidden" name="group_id" value="{{ group.id }}">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-hover" id="availableEmailsTable">
                    <thead class="sticky-top bg-light">
                        <tr>
                            <th width="40"><input type="checkbox" class="form-check-input" id="selectAll"></th>
                            <th>Email Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in available_emails %}
                        <tr class="email-row">
                            <td>
                                <input type="checkbox" name="emails" value="{{ item.email }}"
                                    class="form-check-input email-checkbox">
                            </td>
                            <td class="email-text">{{ item.email }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-center py-3 text-muted">All active employees are already in this
                                group or no active employees found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-3 d-flex justify-content-between align-items-center">
                <div id="selectedCount" class="text-muted small">0 emails selected</div>
                <button type="submit" class="btn btn-success" id="addSelectedBtn" disabled>
                    <i class="bi bi-person-plus-fill"></i> Add Selected Emails
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('availableEmailSearch');
        const table = document.getElementById('availableEmailsTable');
        const rows = table.querySelectorAll('.email-row');
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.email-checkbox');
        const addBtn = document.getElementById('addSelectedBtn');
        const countDisplay = document.getElementById('selectedCount');

        // Search functionality
        searchInput.addEventListener('input', function () {
            const query = this.value.toLowerCase();
            rows.forEach(row => {
                const email = row.querySelector('.email-text').textContent.toLowerCase();
                if (email.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                    // Uncheck hidden rows if selectAll is used later? 
                    // Better to just filter and let user select what's visible
                }
            });
        });

        // Select All visible
        selectAll.addEventListener('change', function () {
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const cb = row.querySelector('.email-checkbox');
                    cb.checked = this.checked;
                }
            });
            updateUI();
        });

        // Individual checkbox change
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateUI);
        });

        function updateUI() {
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            addBtn.disabled = checkedCount === 0;
            countDisplay.innerText = `${checkedCount} email(s) selected`;

            // Update selectAll state
            const visibleCheckboxes = Array.from(checkboxes).filter(cb =>
                cb.closest('.email-row').style.display !== 'none'
            );
            if (visibleCheckboxes.length > 0) {
                selectAll.checked = visibleCheckboxes.every(cb => cb.checked);
            }
        }
    });
</script>

<style>
    .sticky-top {
        z-index: 10;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }

    .table-responsive::-webkit-scrollbar {
        width: 8px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    .email-row:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}
{% extends "base.html" %}
{% block title %}Home - AcornHUB{% endblock %}

{% block content %}
<h1>Welcome to AcornHUB</h1>

{% if error %}
<div class="alert alert-danger">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

<!-- Top Stats Cards -->
<div class="dashboard-stats">
    <div class="stat-box stat-box-uniform">
        <h3>Registered Employees</h3>
        <p id="employeeCount" class="big-number">{{ employee_count }}</p>
    </div>
    <div class="stat-box stat-box-uniform">
        <h3>Active Devices</h3>
        <p id="activeDeviceCount" class="big-number">{{ active_devices }}</p>
    </div>
    <div class="stat-box">
        <h3>Messages Sent</h3>
        <select id="timeFilter" onchange="fetchSentMessages()">
            <option value="day">Last 24 Hours</option>
            <option value="month">Last 30 Days</option>
        </select>
        <canvas id="sentMessagesChart"></canvas>
    </div>
</div>

<!-- Full Width Content Table -->
<div class="content-full">
    <h2>Content Reactions & Feedback</h2>

    {% if paginated_stats %}
    <div class="table-responsive">
        <table class="content-table">
            <thead class="table-dark">
                <tr>
                    <th style="width: 28%;">Message Title</th>
                    <th style="width: 14%;">Sent Date & Time</th>
                    <th>Likes</th>
                    <th>Unlikes</th>
                    <th>Hearts</th>
                    <th>Cries</th>
                    <th>Feedback</th>
                    <th>Views</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in paginated_stats %}
                <tr>
                    <td>
                        <strong>{{ stat.title }}</strong>
                    </td>
                    <td class="text-center" style="font-size: 0.9em; color: #555;">
                        {{ stat.sent_date|safe }}
                    </td>
                    <td class="text-center">{{ stat.like_count }}</td>
                    <td class="text-center">{{ stat.unlike_count }}</td>
                    <td class="text-center">{{ stat.heart_count }}</td>
                    <td class="text-center">{{ stat.cry_count }}</td>
                    <td class="text-center">{{ stat.feedback_count }}</td>
                    <td class="text-center"><strong>{{ stat.view_count }}</strong></td>
                    <td>
                        <a href="{{ url_for('view_reactions', content_id=stat.id) }}" 
                           class="view-btn">View Details</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination mt-4">
        {% if current_page > 1 %}
            <a href="?page={{ current_page - 1 }}" class="page-link">Previous</a>
        {% endif %}

        {% for page_num in range(1, total_pages + 1) %}
            <a href="?page={{ page_num }}" 
               class="page-link {% if page_num == current_page %}active{% endif %}">
                {{ page_num }}
            </a>
        {% endfor %}

        {% if current_page < total_pages %}
            <a href="?page={{ current_page + 1 }}" class="page-link">Next</a>
        {% endif %}
    </div>

    {% else %}
    <div class="text-center py-5 text-muted">
        <p>No messages have been sent yet.</p>
    </div>
    {% endif %}
</div>

<style>
    .dashboard-stats {
        display: flex;
        gap: 20px;
        margin: 30px 0;
        flex-wrap: wrap;
    }
    .stat-box {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        flex: 1;
        min-width: 220px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .stat-box-uniform {
        height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .stat-box h3 {
        margin: 0 0 10px;
        color: #444;
        font-size: 1.1em;
    }
    .big-number {
        font-size: 2.8em;
        font-weight: bold;
        color: #007bff;
        margin: 10px 0;
    }
    #sentMessagesChart {
        max-height: 200px;
        margin-top: 15px;
    }
    .content-full {
        margin-top: 20px;
    }
    .content-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-radius: 8px;
        overflow: hidden;
    }
    .content-table th {
        background-color: #007bff;
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: 600;
    }
    .content-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    .content-table tr:hover {
        background-color: #f5f9ff;
    }
    .view-btn {
        background-color: #007bff;
        color: white;
        padding: 6px 14px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9em;
        transition: all 0.3s;
    }
    .view-btn:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
    }
    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 30px 0;
        flex-wrap: wrap;
    }
    .page-link {
        padding: 8px 14px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
    }
    .page-link:hover {
        background: #e7f1ff;
    }
    .page-link.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Animate numbers
        function animateValue(id, start, end, duration) {
            if (start === end) {
                document.getElementById(id).textContent = end;
                return;
            }
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = Math.floor(progress * (end - start) + start);
                document.getElementById(id).textContent = current;
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        animateValue('employeeCount', 0, '{{ employee_count }}', 1500);
        animateValue('activeDeviceCount', 0, '{{ active_devices }}', 1500);

        // Sent Messages Chart
        const ctx = document.getElementById('sentMessagesChart').getContext('2d');
        let chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Messages', data: [], backgroundColor: '#36a2eb' }] },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });

        async function fetchSentMessages() {
            const filter = document.getElementById('timeFilter').value;
            const res = await fetch(`/get_sent_messages?filter=${filter}`);
            const data = await res.json();
            chart.data.labels = data.labels;
            chart.data.datasets[0].data = data.counts;
            chart.update();
        }

        fetchSentMessages();
    });
</script>
{% endblock %}
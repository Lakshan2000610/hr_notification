{% extends "base.html" %}
{% block title %}View Reactions - {{ content_id }}{% endblock %}

{% block content %}
<style>
    body { margin:0; padding:0; background:#ece4f7; font-family:'Segoe UI',Arial,sans-serif; overflow-x:hidden; }
    .content-container { margin-top:80px; padding:30px 20px; max-width:1400px; margin:auto; position:relative; z-index:1; }
    .content-header { background:white; padding:25px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); margin-bottom:30px; text-align:center; }
    .content-header h2 { color:#333; margin:0 0 15px; font-size:28px; }
    .content-header p { color:#555; font-size:18px; line-height:1.6; margin:0; }
    .media-container { margin:30px auto; text-align:center; }
    .media-container video, .media-container img { max-width:100%; height:auto; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
    .section { display:flex; flex-wrap:wrap; gap:30px; margin:40px 0; justify-content:center; }
    .chart-container, .table-container { background:white; padding:25px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); flex:1; min-width:300px; max-width:600px; }
    .chart-container h2, .table-container h2 { text-align:center; color:#333; margin:0 0 20px; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { padding:14px; text-align:left; border-bottom:1px solid #eee; }
    th { background:#f8f9fa; font-weight:600; color:#333; }
    tr:hover { background:#f5f5f5; }
    .pagination { text-align:center; margin-top:15px; }
    
    .pagination button { padding:8px 14px; margin:0 4px; border:1px solid #b8a9d9; background:white; border-radius:6px; cursor:pointer; }
    .pagination button:hover:not(:disabled) { background:#b8a9d9; color:white; }
    .pagination button:disabled { opacity:0.5; cursor:not-allowed; }
    .snow-container { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }
    .snow-emoji { position:absolute; font-size:28px; animation:snow-fall linear forwards; user-select:none; }
    @keyframes snow-fall { 0%{transform:translateY(-100px) rotate(0deg);opacity:1} 100%{transform:translateY(100vh) rotate(360deg);opacity:0} }
    .no-data { text-align:center; color:#777; font-style:italic; padding:40px; }
</style>

<div class="content-container">
    {% if error %}
    <div style="background:#ffebee;color:#c62828;padding:20px;border-radius:12px;margin-bottom:20px;">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Message Content -->
    <div class="content-header">
        <h2>{{ content_title }}</h2>
        <p>{{ content_text }}</p>
    </div>

    <!-- Media Display -->
    {% if content_type in ['image', 'video', 'both'] and (image_url or video_url) %}
    <div class="media-container">
        {% if video_url and content_type in ['video', 'both'] %}
        <video controls style="max-width:700px;">
            <source src="{{ video_url }}" type="video/mp4">
            Your browser does not support video.
        </video>
        {% endif %}
        {% if image_url and content_type in ['image', 'both'] %}
        <div style="margin-top:20px;">
            <img src="{{ image_url }}" alt="Message Image">
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Reactions Chart + Table -->
    <div class="section">
        <div class="chart-container">
            <h2>Reaction Statistics</h2>
            <canvas id="reactionChart"></canvas>
        </div>

        <div class="table-container">
            <h2>Individual Reactions</h2>
            <table id="reactionTable">
                <thead>
                    <tr><th>Employee</th><th>Reaction</th><th>Time</th></tr>
                </thead>
                <tbody id="reactionTableBody"></tbody>
            </table>
            <div class="pagination" id="reactionPagination"></div>
            <div id="noReactions" class="no-data" style="display:none;">No reactions yet</div>
        </div>
    </div>

    <!-- Feedback + Department Chart -->
    <div class="section">
        <div class="table-container">
            <h2>Feedback Messages</h2>
            {% if feedback_details %}
            <table>
                <thead><tr><th>Employee</th><th>Feedback</th><th>Time</th></tr></thead>
                <tbody>
                    {% for f in feedback_details %}
                    <tr>
                        <td>{{ f.employee_email }}</td>
                        <td>{{ f.feedback }}</td>
                        <td>{{ f.timestamp }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-data">No feedback received</div>
            {% endif %}
        </div>

        <div class="chart-container">
            <h2>Reactions by Department</h2>
            <canvas id="departmentChart"></canvas>
            <div id="noDeptData" class="no-data" style="display:none;">Not enough data</div>
        </div>
    </div>
</div>

<!-- Snow Animation -->
<div class="snow-container" id="snowContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // THIS IS THE ONLY CORRECT WAY WHEN PASSING PYTHON LIST
    const reactionDetails = '{{ reaction_details|tojson }}';

    const emojiMap = { 
        'like': 'thumbs up', 
        'unlike': 'thumbs down', 
        'heart': 'red heart', 
        'cry': 'crying face' 
    };

    document.addEventListener("DOMContentLoaded", function () {
        console.log("Reactions loaded:", reactionDetails); // â† Now you will see an ARRAY

        // === Reaction Chart ===
        const reactionCount = {};
        reactionDetails.forEach(r => {
            reactionCount[r.reaction] = (reactionCount[r.reaction] || 0) + 1;
        });

        if (Object.keys(reactionCount).length > 0) {
            new Chart(document.getElementById('reactionChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(reactionCount).map(k => emojiMap[k] || k),
                    datasets: [{
                        data: Object.values(reactionCount),
                        backgroundColor: ['#4CAF50', '#F44336', '#E91E63', '#9C27B0'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // === Department Chart ===
        const deptCount = {};
        reactionDetails.forEach(r => {
            const match = r.employee_email.match(/\.([a-zA-Z]+)@/i);
            if (match) {
                const dept = match[1].toUpperCase();
                deptCount[dept] = (deptCount[dept] || 0) + 1;
            }
        });

        if (Object.keys(deptCount).length > 0) {
            new Chart(document.getElementById('departmentChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(deptCount),
                    datasets: [{ data: Object.values(deptCount), backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'] }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        } else {
            document.getElementById('noDeptData').style.display = 'block';
        }

        // === Reactions Table ===
        const tableBody = document.getElementById('reactionTableBody');
        const noMsg = document.getElementById('noReactions');

        if (reactionDetails.length === 0) {
            noMsg.style.display = 'block';
        } else {
            reactionDetails.forEach(r => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${r.employee_email}</td>
                    <td>${emojiMap[r.reaction] || r.reaction}</td>
                    <td>${r.timestamp}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // === Snow Animation ===
        const top = Object.keys(reactionCount).reduce((a,b) => reactionCount[a] > reactionCount[b] ? a : b, null);
        if (top && emojiMap[top]) {
            const emoji = emojiMap[top];
            const container = document.getElementById('snowContainer');
            function snow() {
                const s = document.createElement('div');
                s.className = 'snow-emoji';
                s.textContent = emoji;
                s.style.left = Math.random() * 100 + 'vw';
                s.style.animationDuration = (Math.random() * 5 + 7) + 's';
                s.style.fontSize = (Math.random() * 20 + 25) + 'px';
                container.appendChild(s);
                setTimeout(() => s.remove(), 15000);
            }
            for (let i = 0; i < 30; i++) setTimeout(snow, i * 100);
            setInterval(snow, 400);
        }
    });
</script>


{% endblock %}